# 📊 종목 페이지 개발 요구사항

> **메르 블로그 플랫폼** 종목 상세 페이지 (`/merry/stocks/[ticker]`) 개발을 위한 포괄적 요구사항 문서

---

## 🎯 **페이지 구조 및 데이터 소스**

종목 페이지는 3개의 주요 섹션으로 구성되며, 각 섹션별로 지정된 데이터 소스만 사용해야 합니다.

### 📈 **1. 종목 헤더 섹션**
**데이터 소스**: `stocks` 테이블 + Finance API
- **기본 정보**: 
  - 티커 (`stocks.ticker`)
  - 한국 회사명 (`stocks.company_name`)
  - 회사 설명 (`stocks.description`)
  - 관련 태그 (`stocks.tags`)
  - 시장 정보 (`stocks.market`, `stocks.sector`, `stocks.industry`)
- **실시간 가격**: Yahoo Finance API 연동
  - 현재가, 등락률, 거래량
  - 통화별 표시 (KRW/USD)

### 📊 **2. 차트 섹션**  
**데이터 소스**: `stock_prices`, `post_stock_analysis`

## 🎯 **핵심 기능 요구사항**

### 📈 **차트 시스템**
- **기본 표시**: 
  - **모바일**: 3개월치 차트 (3M) 기본 표시
  - **데스크탑**: 1년치 차트 (1Y) 기본 표시
- **시간 범위**: 1M, 3M, 6M, 1Y 선택 가능
- **차트 라이브러리**: Recharts 사용 필수
- **반응형**: 모바일 최적화 필수
- **상호작용**: 드래그 스크롤만 지원 (확대/축소 기능 제거)

### 🏢 **종목 정보**
- **기본 정보**: 티커, 회사명, 현재가, 등락률
- **실시간 가격**: Yahoo Finance API 연동
- **회사 소개**: 실제 사업 영역 한줄 소개 (성의있게 작성)
- **시장 정보**: 상장 시장, 통화, 섹터

### 🎯 **메르 언급 마커**
- **표시 대상**: 메르가 해당 종목을 언급한 날짜만
- **데이터 소스**: `blog_posts` 테이블 직접 검색
- **시간 범위별**: 선택된 기간(1M/3M/6M/1Y) 내 모든 언급
- **마커 클릭**: 해당 포스트 요약 팝업

## 🎨 **감정 분석 시스템 요구사항**

### 🧠 **분석 철학**
- **🚨 AI API 절대 금지**: OpenAI, Anthropic, Claude API 등 모든 외부 AI API 사용 절대 금지
- **Claude 수동 분석**: Claude가 포스트 내용을 읽고 수동으로 직접 감정 분석
- **논리적 근거**: 분석 결과의 근거만 봐도 감정 판단이 논리적으로 납득 가능해야 함
- **맥락 이해**: 단순 키워드 매칭이 아닌 문맥과 의도 파악
- **투자 관점**: 투자자 시각에서 해당 종목에 대한 긍정/부정/중립 판단

### 📊 **감정 분류 기준**

#### 🟢 **긍정적 (Positive)**
**판단 기준**: 해당 종목의 주가 상승 또는 투자 매력도 증가 요인
**예시 근거**:
- "AI 칩 시장 급성장으로 TSMC 파운드리 사업 강화 전망"
- "삼성전자 3나노 수율 실패로 TSMC 기술 우위 확실"
- "실적 개선으로 목표가 상향 조정"
- "신사업 진출로 성장 동력 확보"

#### 🔴 **부정적 (Negative)**
**판단 기준**: 해당 종목의 주가 하락 또는 투자 리스크 증가 요인
**예시 근거**:
- "트럼프 인텔 CEO 사임 요구로 반도체 업계 정치적 리스크"
- "실적 악화로 목표가 하향 조정"
- "경쟁사 대비 기술 격차 확대"
- "규제 강화로 사업 환경 악화"

#### 🔵 **중립적 (Neutral)**
**판단 기준**: 투자 판단에 중립적이거나 단순 정보 전달
**예시 근거**:
- "대만 정부 지분 7% 보유로 정부-민간 하이브리드 구조"
- "분기별 정기 실적 발표"
- "기업 지배구조 변경 발표"
- "단순 뉴스 인용 또는 사실 전달"

### 🎯 **분석 품질 기준**

#### ✅ **논리적 근거 작성 원칙**
1. **구체적 사실**: 추상적 표현보다 구체적 사실과 수치 활용
2. **인과관계 명확**: 왜 긍정/부정인지 논리적 연결고리 제시
3. **투자 관점**: 주가나 기업가치에 미치는 영향 관점에서 서술
4. **간결성**: 핵심 요점을 한 문장으로 명확히 요약
5. **명사 종결**: 동사를 명사형으로 표현하여 명사로 문장 종결 (예: 충분합니다 → 충분, 높입니다 → 증대)

#### ❌ **절대 금지 사항**
- **🚨 AI API 호출**: OpenAI, Anthropic, Claude API 등 모든 AI API 호출 절대 금지
- **🚨 자동화 분석**: 자동화된 감정 분석 시스템이나 스크립트 사용 금지  
- **키워드 분석**: "상승", "하락" 등 단순 키워드 기반 판단 금지
- **패턴 매칭**: 정규식이나 패턴 매칭을 통한 자동 분석 금지
- **자동화된 로직**: if-else 분기문이나 점수 계산 알고리즘 사용 절대 금지
- **글자수 기준**: 문장 길이나 글자수로 감정 판단 금지
- **규칙 기반 시스템**: 미리 정의된 규칙이나 로직으로 판단 금지
- **배치 처리**: 대량 포스트 자동 감정 분석 스크립트 사용 금지

### 🔧 **기술적 구현**

#### 📋 **데이터베이스 구조**
```sql
-- post_stock_analysis 테이블
CREATE TABLE post_stock_analysis (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    post_id INTEGER NOT NULL,
    ticker TEXT NOT NULL,
    sentiment TEXT NOT NULL CHECK (sentiment IN ('positive', 'negative', 'neutral')),
    sentiment_score DECIMAL(4,3) NOT NULL,
    confidence DECIMAL(4,3) NOT NULL,
    reasoning TEXT NOT NULL, -- 핵심 근거 (필수)
    context_snippet TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (post_id) REFERENCES blog_posts(id) ON DELETE CASCADE,
    UNIQUE(post_id, ticker)
);
```

#### 🎨 **마커 색상 시스템**
```javascript
const sentimentColors = {
    positive: '#16a34a',  // 초록색 (투자 매력도 증가)
    negative: '#dc2626',  // 빨간색 (투자 리스크 증가)  
    neutral: '#6b7280',   // 회색 (중립적 정보)
    default: '#2563eb'    // 파란색 (메르 언급만, 감정 분석 없음)
};
```

#### 🔴 **차트 범례 표시**
- **위치**: 가격 정보 아래, 차트 위 중앙 정렬
- **표시 조건**: 항상 표시 (감정 데이터 유무와 관계없이)
- **스타일**: 모든 원은 빈원(border-2)으로 표시
  - ⭕ 긍정: 초록색 테두리 (`#16a34a`)
  - ⭕ 부정: 빨간색 테두리 (`#dc2626`)
  - ⭕ 중립: 회색 테두리 (`#6b7280`)
  - ⭕ 메르 언급: 파란색 테두리 (`#2563eb`)
- **크기**: `w-3 h-3` (12px x 12px)
- **텍스트**: 각 원 옆에 작은 라벨 (text-xs)
- **중요**: 감정 분석 데이터가 없어도 범례는 항상 중앙에 표시

#### 📊 **차트 통합 표시**
- **마커 위치**: 해당 날짜의 주가 차트 위에 원형 마커
- **색상 우선순위**: 하나의 날짜에 여러 감정이 있을 경우 긍정 > 부정 > 중립 순으로 표시
- **툴팁 내용**: 감정 아이콘 + 근거 텍스트 + 신뢰도
- **상호작용**: 마커 클릭/호버시 상세 감정 분석 결과 표시

### 📈 **차트 시스템 세부 요구사항**
- **차트 라이브러리**: Recharts 사용 필수
- **반응형**: 모바일 최적화 필수
- **상호작용**: 
  - **데스크톱**: 확대/축소, 드래그 스크롤 지원
  - **모바일**: 드래그/줌 비활성화, 툴팁 스와이프 우선
  - **터치 이벤트**: `touchAction: 'pan-y'`로 세로 스크롤만 허용
- **메르 언급 마커**: 메르가 해당 종목을 언급한 날짜만 표시
- **마커 클릭**: 해당 포스트 요약 팝업
- **애니메이션**: 차트 로드 시 부드러운 애니메이션 효과 
  - **1단계**: 가격 차트 라인 좌우로 드로잉 (600ms, ease-out) - 모든 기간 통일
  - **2단계**: 마커(원형) 제자리에서 페이드인 애니메이션 (0.2s, 0.05s + index * 0.01s 지연)
    - **시작**: opacity: 0, scale: 0 (투명하고 크기 0)
    - **종료**: opacity: 1, scale: 1 (정상 크기로 나타남)
    - **중요**: translateX 없음, 중간 확대 없음 - 제자리에서 부드럽게 나타남
- **마커 애니메이션**: 호버 시 마커 확대/축소 효과
- **툴팁 애니메이션**: 페이드인/아웃 효과로 부드러운 표시
- **줌 기능**: 제거됨 (사용자 경험 단순화)
  - **드래그 줌**: 비활성화
  - **클릭 확대**: 비활성화  
  - **줌 리셋 버튼**: 제거
- **기간별 차트 설정**: 
  - **1M**: 3일 간격 X축, 일봉 데이터, 상세 툴팁
  - **3M**: 15일 간격 X축, 일봉 데이터, 중간 상세도 툴팁
  - **6M**: 월별 X축, 일봉 데이터, 요약 툴팁 
  - **1Y**: 월별 X축, 주봉 변환 가능, 트렌드 중심 툴팁

### ⚡ **성능 요구사항**

#### 🚀 **로딩 성능**
- **전체 페이지**: < 3초 (절대 한계)
- **차트 렌더링**: < 1.5초
- **API 응답**: < 500ms
- **상호작용 지연**: < 100ms

#### 📦 **데이터 최적화**
- **가격 데이터**: 메르 언급 종목만 저장
- **감정 분석**: 12시간 캐싱
- **포스트 검색**: 인덱스 최적화
- **실시간 가격**: 5분 캐싱

### 🧪 **테스트 요구사항**

#### 📋 **Playwright 필수 테스트**
1. **차트 로딩**: 6개월치 데이터 정상 표시
2. **감정 마커**: 올바른 색상과 위치
3. **시간 범위**: 1M/3M/6M/1Y 전환 테스트
4. **툴팁 표시**: 감정 분석 정보 정확성
5. **반응형**: 모바일/데스크톱 호환성

#### 🎯 **감정 분석 품질 검증**
```javascript
// 테스트 시나리오 예시
const sentimentTest = {
    positive: "AI 칩 시장 급성장으로 TSMC 파운드리 사업 강화 전망",
    negative: "트럼프 인텔 CEO 사임 요구로 반도체 업계 정치적 리스크", 
    neutral: "대만 정부 지분 7% 보유로 정부-민간 하이브리드 구조"
};

// 각 근거를 읽고 감정 분류가 논리적으로 납득되는지 확인
```

### 🎨 **UI/UX 가이드라인**

#### 🎯 **감정 표시 원칙**
- **직관적 색상**: 긍정=초록, 부정=빨강, 중립=회색
- **명확한 구분**: 각 감정별 고유 아이콘 사용
- **상세 정보**: 근거 텍스트는 읽기 쉽게 표시
- **신뢰도 표시**: 분석 확신도를 시각적으로 표현

#### 📱 **반응형 디자인**
- **모바일**: 터치 친화적 마커 크기
- **데스크톱**: 호버 상태 인터랙션
- **태블릿**: 중간 크기 최적화

### 📝 **3. 관련 포스트 섹션**
**데이터 소스**: `blog_posts` 테이블
- **검색 방식**: `blog_posts` 테이블에서 직접 검색
- **검색 로직**: 
  - 제목, 내용, 발췌문에서 티커명 + 회사명 검색
  - 예: 'TSLA' + '테슬라', '005930' + '삼성전자'
- **표시 내용**:
  - 포스트 제목, 발췌문, 작성일, 조회수
  - 기본 5개, 더보기 기능으로 추가 로딩
- **정렬**: 최신 작성일 순 (`created_date DESC`)

---

## 🗄️ **데이터베이스 사용 제한**

### ✅ **허용된 테이블 (4개만)**
1. **`stocks`** - 종목 기본 정보 (회사명, 설명, 태그)
2. **`stock_prices`** - 주가 차트 데이터  
3. **`post_stock_analysis`** - 포스트별 종목 분석 (감정 분석 포함)
4. **`blog_posts`** - 관련 포스트 데이터

### ❌ **사용 금지 테이블**
- `merry_mentioned_stocks` (메르's Pick 전용)
- `causal_chains` (논리체인 분석 전용)
- `merry_pattern_analysis` (패턴 분석 전용)
- 기타 분석/통계 테이블

---

## 🔧 **API 구조**

### 📊 **메인 종목 API** (`/api/merry/stocks/[ticker]`)
```typescript
interface StockResponse {
  ticker: string;
  name: string;              // stocks.company_name
  description: string;       // stocks.description  
  tags: string[];           // stocks.tags
  market: string;           // stocks.market
  currentPrice: number;     // Finance API
  priceChange: string;      // Finance API
  currency: string;         // KRW/USD
  chartData: PricePoint[];  // stock_prices 테이블
  relatedPosts: Post[];     // blog_posts 검색 결과
}
```

### 📈 **감정 분석 API** (`/api/merry/stocks/[ticker]/sentiments`)
```typescript
interface SentimentResponse {
  ticker: string;
  sentimentByDate: {
    [date: string]: {
      sentiments: SentimentData[];
      posts: Post[];
    }
  };
  summary: {
    positive: number;
    negative: number; 
    neutral: number;
  };
}
```

---

## 🎨 **UI/UX 요구사항**

### 📱 **반응형 디자인**
- **데스크톱**: 3컬럼 레이아웃 (헤더 + 차트 + 포스트)
- **태블릿**: 2컬럼 레이아웃 (헤더 위, 차트/포스트 나란히)
- **모바일**: 1컬럼 레이아웃 (세로 스택)

### 🎯 **종목 헤더 표시**
- **한국 종목**: 한국어 회사명 + 한국어 설명 + 한국어 태그
- **미국 종목**: 영어 회사명 + 영어 설명 + 영어 태그
- **실시간 가격**: 색상으로 등락 표시 (상승=빨강, 하락=파랑)
- **태그**: 배지 형태로 표시, 클릭 시 관련 종목 검색

### 📊 **차트 통합**
- **마커 표시**: 메르 언급일에만 표시
- **감정 색상**: sentiment 데이터 기반 색상 적용
- **툴팁**: 해당 날짜의 포스트 제목 + 감정 분석 결과
- **시간 범위**: 버튼으로 1M/3M/6M/1Y 전환

### 📝 **포스트 목록**
- **카드 형태**: 제목, 발췌문, 날짜, 조회수
- **무한 스크롤**: 또는 페이지네이션
- **클릭 동작**: 해당 포스트 상세 페이지로 이동

---

## ⚡ **성능 요구사항**

### 🚀 **로딩 성능** (CLAUDE.md 핵심 기준)
- **전체 페이지**: < 3초 (절대 한계)
- **종목 헤더**: < 1초 
- **차트 렌더링**: < 1.5초
- **포스트 목록**: < 2초

### 📦 **캐싱 전략**
- **종목 기본 정보**: 1시간 캐싱
- **실시간 가격**: 5분 캐싱  
- **차트 데이터**: 30분 캐싱
- **감정 분석**: 12시간 캐싱
- **관련 포스트**: 1시간 캐싱

---

## 🧪 **테스트 요구사항**

### 📋 **Playwright 필수 테스트**
1. **종목 헤더**: 한국/미국 종목별 정보 정확성
2. **실시간 가격**: API 연동 및 색상 표시
3. **차트 로딩**: 6개월 데이터 + 감정 마커  
4. **포스트 검색**: 관련 포스트 정확한 필터링
5. **반응형**: 모바일/태블릿/데스크톱 호환성

### 🎯 **데이터 무결성 테스트**
- **실제 데이터**: Dummy 데이터 사용 절대 금지
- **빈 데이터**: "정보 없음" 적절한 표시
- **API 실패**: Fallback 처리 및 에러 메시지
- **잘못된 티커**: 404 페이지 또는 적절한 안내

---

## 📁 **파일 구조**

### 🗂️ **핵심 파일들**
- **`src/app/merry/stocks/[ticker]/page.tsx`**: 메인 종목 페이지
- **`src/app/api/merry/stocks/[ticker]/route.ts`**: 종목 정보 API
- **`src/app/api/merry/stocks/[ticker]/sentiments/route.ts`**: 감정 분석 API
- **`src/components/merry/StockPriceChart.tsx`**: 차트 컴포넌트 (아래 차트 섹션 참조)
- **`src/lib/stock-db-sqlite3.js`**: 데이터베이스 유틸리티

### 🔄 **데이터 플로우**
1. **URL 파라미터**: ticker 추출 및 검증
2. **병렬 API 호출**: 
   - 종목 정보 (`stocks` + Finance API)
   - 차트 데이터 (`stock_prices`)
   - 감정 분석 (`post_stock_sentiments`)  
   - 관련 포스트 (`blog_posts` 검색)
3. **데이터 통합**: 날짜별 차트 + 감정 + 포스트 매칭
4. **UI 렌더링**: 3개 섹션 독립적 렌더링

---

## 🛡️ **보안 및 안정성**

### 🔒 **입력 검증**
- **Ticker 검증**: 알파벳/숫자만, 최대 10자
- **SQL 인젝션**: Prepared statements 필수
- **API 레이트 제한**: Finance API 호출 제한

### 🚨 **에러 처리**
- **종목 없음**: 404 또는 "종목을 찾을 수 없습니다"
- **API 실패**: 기본값 표시 + 재시도 버튼
- **차트 오류**: 텍스트 대체 메시지
- **네트워크 오류**: 오프라인 상태 안내

---

## 📊 **참조 문서**

### 🔗 **관련 문서**
- **차트 시스템**: 이 문서의 차트 섹션 참조
- **감정 분석**: 이 문서의 감정 분석 섹션 참조
- **성능 요구사항**: `@docs/performance-requirements.md`
- **테스트 요구사항**: `@docs/testing-requirements.md`

### 📋 **CLAUDE.md 참조 섹션**
- **📊 종목 페이지 개발 시**: 기본 기능 요구사항
- **🎯 감정 분석 시스템**: 완전 구현 가이드
- **⚡ 성능 최적화**: 3초 로딩 제한

---

**📌 마지막 업데이트**: 2025-08-22  
**🎯 핵심 원칙**: stocks + Finance API (헤더) | 차트 + 감정 분석 (통합) | blog_posts (포스트)  
**🧪 테스트**: `npx playwright test --grep "stock-page"`  
**🌐 확인**: `http://localhost:3006/merry/stocks/005930`